<svg viewBox="0 0 800 800" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <style type="text/css"><![CDATA[
      foreignObject { --s:4em; --h:2em; --t:2s; --c:#f5f5f5 }
      foreignObject * { margin:0; box-sizing:border-box }

      .assembly {
        position:absolute;
        inset:0; margin:auto;
        width:max-content; height:max-content;
        transform:rotateX(-45deg) rotateY(-45deg);
        transform-style:preserve-3d;
      }

      .comp-3d { animation:var(--t) ease-in-out infinite }

      .comp-3d--i { animation-name:ri }
      .comp-3d--o { animation-name:ro }

      @keyframes ri {
        0%,20%   { transform:rotateY(-.5turn) }
        50%      { transform:none }
        80%,to   { transform:rotateX(-.5turn) }
      }
      @keyframes ro {
        0%,35%   { transform:rotate(-.5turn) }
        65%,to   { transform:none }
      }
      @keyframes m {
        0%,5%,95%,to { transform:none }
        15% { transform:translate3d(0,var(--s),0) }
        25% { transform:translate3d(0,var(--s),var(--s)) }
        35%,65% { transform:translate3d(var(--s),var(--s),var(--s)) }
        75% { transform:translate3d(var(--s),0,var(--s)) }
        85% { transform:translate3d(var(--s),0,0) }
      }

      /* CSS Nesting + DRY estremo */
      .cube {
        position:absolute;
        transform-style:preserve-3d;

        & .cube__face {
          position:absolute;
          margin:-var(--h);
          width:var(--s); height:var(--s);
          background:var(--c);
          box-shadow:0 0 2em #dcdcdc88 inset;
          backface-visibility:hidden;

          &:nth-child(2n) { filter:brightness(.97) }
          &:nth-child(n+5) { filter:brightness(1.03) }

          &:nth-child(1) { transform:rotateY(0deg)   translateZ(var(--h)) }
          &:nth-child(2) { transform:rotateY(90deg)  translateZ(var(--h)) }
          &:nth-child(3) { transform:rotateY(180deg) translateZ(var(--h)) }
          &:nth-child(4) { transform:rotateY(270deg) translateZ(var(--h)) }
          &:nth-child(5) { transform:rotateX(90deg)  translateZ(var(--h)) }
          &:nth-child(6) { transform:rotateX(-90deg) translateZ(var(--h)) }
        }
      }

      /* Posizioni esterne (8 cubi) – solo 8 regole invece di 27 */
      .pos   { transform:scale3d(var(--x,1),var(--y,1),var(--z,1)) translate3d(var(--s),var(--s),var(--s)) }
      .pos:nth-child(1) { --x:1;  --y:1;  --z:1 }
      .pos:nth-child(2) { --x:1;  --y:1;  --z:-1 }
      .pos:nth-child(3) { --x:1;  --y:-1; --z:1 }
      .pos:nth-child(4) { --x:1;  --y:-1; --z:-1 }
      .pos:nth-child(5) { --x:-1; --y:1;  --z:1 }
      .pos:nth-child(6) { --x:-1; --y:1;  --z:-1 }
      .pos:nth-child(7) { --x:-1; --y:-1; --z:1 }
      .pos:nth-child(8) { --x:-1; --y:-1; --z:-1 }

      .pos .cube { animation:m var(--t) ease-out infinite }

      /* 19 cubi interni – posizioni inlined direttamente (zero selector overhead) */
      .comp-3d--i > .cube {
        &:nth-child(1)  { transform:translate3d(calc(-1*var(--s)),calc(-1*var(--s)),0) }
        &:nth-child(2)  { transform:translate3d(calc(-1*var(--s)),0,calc(-1*var(--s))) }
        &:nth-child(3)  { transform:translate3d(calc(-1*var(--s)),0,0) }
        &:nth-child(4)  { transform:translate3d(calc(-1*var(--s)),0,var(--s)) }
        &:nth-child(5)  { transform:translate3d(calc(-1*var(--s)),var(--s),0) }
        &:nth-child(6)  { transform:translate3d(0,calc(-1*var(--s)),calc(-1*var(--s))) }
        &:nth-child(7)  { transform:translate3d(0,calc(-1*var(--s)),0) }
        &:nth-child(8)  { transform:translate3d(0,calc(-1*var(--s)),var(--s)) }
        &:nth-child(9)  { transform:translate3d(0,0,calc(-1*var(--s))) }
        &:nth-child(10) { transform:translate3d(0,0,0) }
        &:nth-child(11) { transform:translate3d(0,0,var(--s)) }
        &:nth-child(12) { transform:translate3d(0,var(--s),calc(-1*var(--s))) }
        &:nth-child(13) { transform:translate3d(0,var(--s),0) }
        &:nth-child(14) { transform:translate3d(0,var(--s),var(--s)) }
        &:nth-child(15) { transform:translate3d(var(--s),calc(-1*var(--s)),0) }
        &:nth-child(16) { transform:translate3d(var(--s),0,calc(-1*var(--s))) }
        &:nth-child(17) { transform:translate3d(var(--s),0,0) }
        &:nth-child(18) { transform:translate3d(var(--s),0,var(--s)) }
        &:nth-child(19) { transform:translate3d(var(--s),var(--s),0) }
      }
    ]]></style>
  </defs>

  <rect width="100%" height="100%" fill="#e9e9e9"/>

  <foreignObject width="800" height="800">
    <div class="assembly" xmlns="http://www.w3.org/1999/xhtml">
      <div class="comp-3d comp-3d--i">
        <div class="cube"><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div></div>
        <div class="cube"><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div></div>
        <div class="cube"><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div></div>
        <div class="cube"><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div></div>
        <div class="cube"><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div></div>
        <div class="cube"><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div></div>
        <div class="cube"><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div></div>
        <div class="cube"><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div></div>
        <div class="cube"><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div></div>
        <div class="cube"><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div></div>
        <div class="cube"><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div></div>
        <div class="cube"><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div></div>
        <div class="cube"><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div></div>
        <div class="cube"><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div></div>
        <div class="cube"><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div></div>
        <div class="cube"><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div></div>
        <div class="cube"><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div></div>
        <div class="cube"><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div></div>
        <div class="cube"><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div></div>
      </div>

      <div class="comp-3d comp-3d--o">
        <div class="pos"><div class="cube"><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div></div></div>
        <div class="pos"><div class="cube"><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div></div></div>
        <div class="pos"><div class="cube"><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div></div></div>
        <div class="pos"><div class="cube"><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div></div></div>
        <div class="pos"><div class="cube"><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div></div></div>
        <div class="pos"><div class="cube"><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div></div></div>
        <div class="pos"><div class="cube"><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div></div></div>
        <div class="pos"><div class="cube"><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div><div class="cube__face"></div></div></div>
      </div>
    </div>
  </foreignObject>
</svg>
